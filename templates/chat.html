<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vyom AI</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        :root {
            --bg: #09090b; 
            --surface: rgba(30, 30, 35, 0.6); 
            --primary: #6366f1;
            --accent: #6366f1;
            --text-main: #f4f4f5; 
            --text-muted: #a1a1aa; 
            --border: rgba(255, 255, 255, 0.08);
            --grad: linear-gradient(135deg, #4b90ff, #ff5546);
            --bg-card: #1e293b;
            --bg-body: #09090b;
            --sidebar-bg: rgba(15, 15, 18, 0.9);
            --header-bg: rgba(9, 9, 11, 0.8);
            --bubble-ai: rgba(255,255,255,0.04);
            --input-bg: rgba(30, 30, 35, 0.7);
        }

        /* Full Theme Definitions */
        body.theme-dark { 
            --bg-body: #09090b; 
            --bg-card: #1e293b; 
            --text-main: #f1f5f9; 
            --sidebar-bg: #0f172a; 
            --header-bg: rgba(15, 23, 42, 0.8);
            --border: rgba(255, 255, 255, 0.1);
            --bubble-ai: rgba(255, 255, 255, 0.05);
            --input-bg: rgba(30, 41, 59, 0.7);
            --accent: #6366f1;
        }
        body.theme-light { 
            --bg-body: #f8fafc; 
            --bg-card: #ffffff; 
            --text-main: #1e293b; 
            --text-muted: #64748b;
            --border: #e2e8f0; 
            --sidebar-bg: #f1f5f9;
            --header-bg: rgba(248, 250, 252, 0.8);
            --bubble-ai: #ffffff;
            --input-bg: #ffffff;
            --accent: #3b82f6;
            --grad: linear-gradient(135deg, #3b82f6, #6366f1);
        }
        body.theme-cyber { 
            --bg-body: #050505; 
            --bg-card: #111; 
            --accent: #0ff; 
            --text-main: #0ff; 
            --text-muted: #0aa;
            --border: #0ff3;
            --sidebar-bg: #0a0a0a;
            --header-bg: rgba(5, 5, 5, 0.9);
            --bubble-ai: #00ff0011;
            --input-bg: #111;
            --grad: linear-gradient(135deg, #00f, #0ff);
        }
        body.theme-matrix { 
            --bg-body: #000; 
            --bg-card: #000; 
            --accent: #00ff00; 
            --text-main: #00ff00; 
            --text-muted: #008800;
            --border: #003300; 
            --sidebar-bg: #000;
            --header-bg: rgba(0, 0, 0, 0.9);
            --bubble-ai: #00330033;
            --input-bg: #000;
            --grad: linear-gradient(135deg, #003300, #00ff00);
        }
        
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Outfit', sans-serif; }
        
        .lab-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            color: var(--text-main);
            cursor: pointer;
            margin-bottom: 10px;
            font-weight: 500;
            transition: 0.2s;
        }
        .lab-btn:hover { background: rgba(255, 255, 255, 0.1); border-color: var(--accent); }

        .lab-modal {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 90%;
            max-width: 400px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 25px;
            z-index: 2000;
            display: none;
            box-shadow: 0 30px 60px rgba(0,0,0,0.5);
        }
        .lab-modal.active { display: block; animation: modalIn 0.3s forwards; }

        .history-panel {
            width: 260px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            padding: 15px;
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
        }
        .new-chat-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border-radius: 10px;
            background: var(--grad);
            background-size: 200% 200%;
            animation: shineText 5s ease infinite;
            color: white;
            cursor: pointer;
            margin-bottom: 20px;
            border: none;
            font-size: 1rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .new-chat-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4); }

        .history-list {
            flex-grow: 1;
            overflow-y: auto;
        }
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 5px;
        }
        .history-item:hover {
            background: rgba(255, 255, 255, 0.06);
        }
        .history-item.active {
            background: rgba(255, 255, 255, 0.1);
        }
        .history-item-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1;
        }
        .history-item-actions {
            display: none;
            gap: 5px;
        }
        .history-item:hover .history-item-actions {
            display: flex;
        }
        .history-item-actions button {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }

        body { 
            background-color: var(--bg-body); color: var(--text-main); height: 100vh; 
            display: flex; flex-direction: row; overflow: hidden;
            background-image: radial-gradient(circle at 15% 25%, rgba(99, 102, 241, 0.05), transparent 40%),
                              radial-gradient(circle at 85% 75%, rgba(255, 85, 70, 0.05), transparent 40%);
            background-attachment: fixed;
            transition: background-color 0.3s, color 0.3s;
        }

        .main-chat-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: margin-left 0.3s ease;
            background: var(--bg-body);
        }
        /* MAIN CHAT AREA */
        .chat-container { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 180px; display: flex; flex-direction: column; gap: 10px; scroll-behavior: smooth; }
        
        /* HEADER */
        .header { 
            padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; 
            background: var(--header-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border); z-index: 50;
        }
        .brand { display: flex; align-items: center; gap: 10px; }
        .brand-logo { height: 32px; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .logo-btn { cursor: pointer; position: relative; z-index: 10; }
        .logo-btn:hover { 
            transform: scale(1.2) rotate(360deg); 
            filter: drop-shadow(0 0 15px var(--accent)); 
        }
        .brand-link { display: flex; align-items: center; gap: 10px; text-decoration: none; color: inherit; }
        .brand-text { font-size: 1.25rem; font-weight: 600; color: var(--text-main); transition: color 0.3s; }
        .brand-link:hover .brand-text { color: var(--accent); }

        .welcome-screen { margin-top: 10vh; text-align: center; padding: 0 20px; animation: fadeIn 0.8s ease forwards; }
        .welcome-logo { height: 90px; margin-bottom: 20px; filter: drop-shadow(0 0 40px rgba(99, 102, 241, 0.3)); }
        .welcome-title { 
            font-size: 2.8rem; font-weight: 600; margin-bottom: 10px; line-height: 1.1;
            background: var(--grad); -webkit-background-clip: text; background-clip: text;
            -webkit-text-fill-color: transparent; color: transparent;
        }

        /* Messages */
        .msg-row { display: flex; gap: 12px; max-width: 850px; margin: 0 auto; width: 100%; animation: slideUp 0.3s ease; align-items:flex-start; }
        .msg-row.user { justify-content: flex-end; }
        .msg-avatar { width: 32px; height: 32px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; border-radius: 50%; overflow: hidden; background: var(--border); }
        .msg-avatar img { width: 100%; height: 100%; object-fit: contain; }
        .msg-content { display: flex; flex-direction: column; max-width: 88%; }
        .user .msg-content { align-items: flex-end; }
        
        .msg-bubble { 
            padding: 12px 18px; border-radius: 18px; font-size: 1rem; line-height: 1.6; 
            color: var(--text-main); position: relative; word-wrap: break-word;
        }
        .user .msg-bubble { 
            background: var(--grad); 
            color: white; 
            border-radius: 18px 18px 4px 18px; 
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.2);
        }
        .ai .msg-bubble { background: var(--bubble-ai); border: 1px solid var(--border); border-radius: 18px 18px 18px 4px; }

        /* Message meta + actions */
        .msg-meta { display:flex; gap:8px; align-items:center; margin-top: 8px; color:var(--text-muted); font-size:0.8rem; opacity: 0; transition: opacity 0.2s ease; }
        .msg-row:hover .msg-meta { opacity: 1; }
        .msg-actions button { background: transparent; border: 1px solid var(--border); color: var(--text-muted); padding:4px 6px; border-radius:6px; cursor:pointer; font-size:0.75rem; }
        .msg-actions button:hover { color: var(--text-main); border-color: var(--accent); }

        .msg-bubble pre { position: relative; background: rgba(0,0,0,0.3); padding: 12px; padding-top: 40px; border-radius: 10px; overflow-x: auto; margin-top: 10px; border: 1px solid var(--border); }
        .msg-bubble img { max-width: 100%; border-radius: 8px; margin-top: 10px; border: 1px solid var(--border); }

        /* Quick suggestion chips */
        .suggestions { display:flex; gap:10px; justify-content:center; margin-top:25px; flex-wrap:wrap; padding: 0 20px; }
        .suggest-chip { background: var(--bubble-ai); border:1px solid var(--border); padding:10px 16px; border-radius:20px; cursor:pointer; color:var(--text-muted); transition: 0.2s; }
        .suggest-chip:hover { color:var(--text-main); border-color: var(--accent); transform: translateY(-2px); }

        /* INPUT AREA */
        .input-section { 
            position: fixed; bottom: 0; left:0; right:0; padding: 20px; display: flex; justify-content: center; 
            background: linear-gradient(to top, var(--bg-body) 70%, transparent); pointer-events: none;
            margin-left: 260px; /* Same as history panel width */
            transition: margin-left 0.3s ease;
        }
        .input-box { 
            pointer-events: auto; width: 100%; max-width: 850px; position: relative;
            background: var(--input-bg); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--border); border-radius: 26px; 
            display: flex; flex-direction: column; align-items: stretch;
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.5); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }
        .input-box:focus-within { 
            border-color: var(--accent); 
            box-shadow: 0 0 30px rgba(99, 102, 241, 0.1);
        }

        .mode-selector {
            display: none;
            gap: 8px;
            padding: 10px 16px;
            border-bottom: 1px solid var(--border);
            width: 100%;
            overflow-x: auto;
            background: rgba(0, 0, 0, 0.15);
            order: -1;
            scrollbar-width: none;
            transition: all 0.3s ease;
        }
        .mode-selector::-webkit-scrollbar { display: none; }
        .mode-selector.active {
            display: flex;
            animation: menuFadeIn 0.3s ease;
        }
        @keyframes menuFadeIn {
            from { opacity: 0; height: 0; }
            to { opacity: 1; height: auto; }
        }
        .tools-btn.active {
            color: white !important;
            background: var(--primary) !important;
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.3);
        }
        .mode-chip {
            font-size: 0.8rem;
            color: var(--text-muted);
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 12px;
            transition: all 0.2s;
            white-space: nowrap;
            border: 1px solid transparent;
            font-weight: 500;
        }
        .mode-chip:hover {
            color: white;
            background: rgba(255,255,255,0.08);
        }
        .mode-chip.active {
            color: white;
            background: var(--grad);
            box-shadow: 0 2px 10px rgba(99, 102, 241, 0.2);
        }

        .preview-area { 
            position: absolute; bottom: calc(100% + 15px); left: 50%; transform: translateX(-50%);
            width: calc(100% - 40px); max-width: 850px;
            display: none; 
            background: rgba(30, 30, 35, 0.95); padding: 12px; border-radius: 20px; 
            border: 1px solid var(--border); align-items: center; gap: 12px; 
            animation: slideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: auto;
            backdrop-filter: blur(10px);
            z-index: 100;
            box-shadow: 0 15px 35px rgba(0,0,0,0.5);
        }
        .preview-img { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; }
        .preview-close { cursor: pointer; color: #ff5546; background: rgba(255,255,255,0.1); border-radius: 50%; padding: 2px; }

        textarea { 
            flex: 1; background: transparent; border: none; color: white; resize: none; 
            height: 44px; max-height: 120px; outline: none; font-size: 1rem; padding: 12px;
        }
        .action-btn { width: 44px; height: 44px; border-radius: 50%; border: none; background: transparent; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; flex-shrink: 0; }
        .action-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .send-btn { background: var(--primary); color: white; }
        .send-btn:hover:not([disabled]) { transform: scale(1.05); }
        .send-btn[disabled] { opacity: 0.5; transform: none; cursor: not-allowed; }

        /* üî• NEURAL GALAXY ANIMATION (The Cool Part) üî• */
        .thinking-wrapper {
            display: flex; align-items: center; gap: 15px; padding: 10px 15px;
            background: rgba(255,255,255,0.03); border-radius: 20px; border: 1px solid var(--border);
            width: fit-content;
        }
        .orbit-spinner {
            position: relative; width: 30px; height: 30px;
            display: flex; justify-content: center; align-items: center;
        }
        .orbit-logo { width: 20px; height: 20px; z-index: 2; opacity: 0.9; }
        
        .ring {
            position: absolute; width: 100%; height: 100%; border-radius: 50%;
            border: 2px solid transparent; border-top-color: #4b90ff; border-right-color: #ff5546;
            animation: spin 1.5s linear infinite; filter: blur(1px);
        }
        .ring:nth-child(2) {
            width: 80%; height: 80%; border-top-color: #ff5546; border-right-color: #4b90ff;
            animation: spin 2s linear infinite reverse;
        }
        
        .thinking-text {
            font-size: 0.95rem;
            font-weight: 500;
            background: linear-gradient(90deg, #a1a1aa, #fff, #a1a1aa);
            background-size: 200% auto;
            color: transparent;
            -webkit-background-clip: text;
            background-clip: text;
            animation: shineText 2s linear infinite;
        }

        /* SETTINGS PANEL */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: flex-end;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            padding: 2rem;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            border: 1px solid var(--border);
            scrollbar-width: thin;
        }
        .modal-content::-webkit-scrollbar { width: 5px; }
        .modal-content::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 10px; }

        /* Responsive Layout Improvements */
        @media (max-width: 768px) {
            .chat-container { width: 100%; height: 100vh; border-radius: 0; }
            .sidebar { position: fixed; left: -100%; z-index: 1000; height: 100%; transition: 0.3s; }
            body.history-open .sidebar { left: 0; width: 80%; }
            .input-wrapper { margin: 10px; }
            .message { max-width: 90%; }
        }

        .theme-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        .theme-btn {
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            background: var(--bg-body);
            color: var(--text-main);
            transition: 0.2s;
        }
        .theme-btn:hover { border-color: var(--accent); }
        .theme-btn.active { background: var(--accent); color: white; }

        .modal-overlay.active .settings-pane {
            transform: translateX(0);
        }
        
        .switch {
            position: relative;
            width: 42px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #3f3f46;
            border-radius: 34px;
            transition: .3s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            border-radius: 50%;
            transition: .3s;
        }

        input:checked+.slider {
            background-color: var(--primary);
        }

        input:checked+.slider:before {
            transform: translateX(18px);
        }
        
        select {
            background: #27272a;
            color: white;
            border: 1px solid var(--border);
            padding: 10px;
            border-radius: 8px;
            width: 100%;
            margin-top: 5px;
            outline: none;
        }

        @keyframes modalIn {
            from { opacity: 0; transform: translate(-50%, -60%) scale(0.9); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes shineText { to { background-position: 200% center; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px) scale(.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .mic-active { color: #ef4444 !important; animation: pulse 1.5s infinite; }

        /* Copy toast */
        .copy-toast {
            position: fixed; right: 24px; bottom: 120px; background: rgba(0,0,0,0.8); color: white; padding: 8px 12px; border-radius: 10px; box-shadow: 0 6px 20px rgba(0,0,0,0.6); opacity: 0; transform: translateY(6px); transition: all .24s ease; pointer-events: none; z-index: 4000;
        }
        .copy-toast.show { opacity: 1; transform: translateY(0); }

        @media (max-width: 600px) {
            .welcome-title { font-size: 2.2rem; }
            .chat-container { padding: 15px; }
            .input-section { padding: 15px; }
            .msg-bubble { max-width: 92%; }
            .settings-pane { width: 85%; }
        }

        .history-panel.collapsed {
            width: 0;
            padding: 15px 0;
            transform: translateX(-100%);
        }
        .header-actions { display: flex; align-items: center; gap: 10px; }
        .profile-btn { 
            width: 36px; height: 36px; border-radius: 50%; border: none; 
            background: var(--grad); color: white;
            display: flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 1rem; cursor: pointer;
        }
        .history-toggle-btn {
            background: transparent; border: none; color: var(--text-muted); cursor: pointer;
        }
        .copy-code-btn {
            position: absolute; top: 8px; right: 8px; background: rgba(255,255,255,0.1); border: none; color: white; padding: 4px 8px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;
        }
        .hud-stat { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; color: var(--text-muted); }
        .hud-stat span { color: var(--accent); font-weight: 600; }
        .hud-tools { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
        .hud-tools button { 
            width: 45px; height: 45px; border-radius: 12px; border: 1px solid var(--border); 
            background: rgba(255,255,255,0.05); color: var(--text-main); cursor: pointer; 
            transition: 0.2s; display: flex; align-items: center; justify-content: center;
        }
        .hud-tools button:hover { background: var(--accent); color: white; border-color: var(--accent); }
        body.history-collapsed .input-section {
            margin-left: 0;
        }
        @media (max-width: 768px) {
            .history-panel {
                position: fixed;
                z-index: 1000;
                height: 100%;
                top: 0;
                left: 0;
            }
            .main-chat-area {
                margin-left: 0 !important;
            }
            body:not(.history-collapsed) .main-chat-area {
                margin-left: 260px;
            }
            .input-section {
                margin-left: 0 !important;
            }
        }
    </style>
</head>
<body class="history-collapsed">
    <div class="history-panel" id="history-panel">
        <button class="new-chat-btn" onclick="startNewChat()">
            <span class="material-symbols-rounded">add</span>
            New Chat
        </button>
        <button class="lab-btn" onclick="toggleLab()">
            <span class="material-symbols-rounded">science</span>
            Vyom Lab
        </button>
        <div class="history-list" id="history-list">
            <!-- History items will be injected here by JavaScript -->
        </div>
    </div>
    <div class="main-chat-area">
        <div class="header">
            <div class="brand">
                <button class="history-toggle-btn" onclick="toggleHistory()">
                    <span class="material-symbols-rounded">menu</span>
                </button>
                <a href="/login" class="brand-link" title="Login / Register">
                    <img src="logo.png" alt="Logo" class="brand-logo logo-btn" onerror="this.style.display='none'">
                    <div style="display:flex; flex-direction:column; justify-content:center;">
                        <span class="brand-text" style="line-height:1;">Vyom AI</span>
                    </div>
                </a>
            </div>
            <div class="header-actions">
                <button class="profile-btn" id="profile-btn" onclick="toggleSettings()">G</button>
            </div>
        </div>

        <div class="chat-container" id="chat-box">
            <div id="welcome" class="welcome-screen">
                <a href="/login" style="display:inline-block">
                    <img src="logo.png" class="welcome-logo logo-btn" onerror="this.src='https://cdn-icons-png.flaticon.com/512/6134/6134346.png'" title="Login / Register">
                </a>
                <h1 class="welcome-title">Namaste, <span id="user-name">Explorer</span></h1>
                <p id="welcome-sub" style="color:#a1a1aa; font-size: 1.1rem;">Aapka apna AI companion. Poochiye jo aap chahein.</p>
                <div class="suggestions" aria-hidden="false">
                    <div class="suggest-chip" onclick="fillSuggestion('Summarize the latest research on reinforcement learning in 3 bullets')">Summarize RL</div>
                    <div class="suggest-chip" onclick="fillSuggestion('Explain the difference between precision and recall with examples')">Precision vs Recall</div>
                    <div class="suggest-chip" onclick="fillSuggestion('Generate a simple Flask API for text classification')">Flask API</div>
                </div>
            </div>
        </div>

        <div class="input-section">
            <div class="preview-area" id="img-preview">
                <img id="thumb" class="preview-img">
                <span class="material-symbols-rounded preview-close" onclick="clearFile()">close</span>
            </div>
            <div class="input-box">
                <div class="mode-selector" id="mode-selector">
                    <!-- Dynamic chips: General, Coding, Math, etc. -->
                </div>
                <div style="display: flex; align-items: center; gap: 8px; padding: 6px 10px;">
                    <button class="action-btn tools-btn" id="tools-btn" onclick="toggleToolsMenu()" title="Vyom Tools & Engines">
                        <span class="material-symbols-rounded">psychology</span>
                    </button>

                    <button class="action-btn" onclick="document.getElementById('file-up').click()" title="Attach file">
                        <span class="material-symbols-rounded">add_photo_alternate</span>
                    </button>
                    <button class="action-btn" onclick="captureCamera()" title="Capture from Camera">
                        <span class="material-symbols-rounded">photo_camera</span>
                    </button>
                    <input type="file" id="file-up" style="display: none;" accept="image/*, .pdf, .docx, .txt, .py" multiple onchange="showPreview(this)">
                    
                    <textarea id="inp" rows="1" placeholder="Ask Vyom AI..."></textarea>

                    <button class="action-btn" id="mic-btn" aria-label="Start voice input" title="Voice input"><span class="material-symbols-rounded">mic</span></button>
                    <button class="action-btn send-btn" id="send-btn" onclick="sendMessage('text')" aria-label="Send message" disabled><span class="material-symbols-rounded">arrow_upward</span></button>
                </div>
            </div>
        </div>
    </div>

    <div class="lab-modal" id="lab-modal">
        <h2 style="color:white; display:flex; justify-content:space-between; margin-bottom:20px; font-size: 1.5rem;">
            Vyom Lab <span class="material-symbols-rounded" style="cursor:pointer" onclick="toggleLab()">close</span>
        </h2>
        <div class="hud-body">
            <div class="hud-stat">
                <label>System Mode</label>
                <span id="stat-mode">Turbo Flash</span>
            </div>
            <div class="hud-stat">
                <label>Intelligence Engine</label>
                <span id="stat-engine">Trinity v2</span>
            </div>
            <hr style="border-color:var(--border); margin:15px 0;">
            <div class="hud-tools">
                <button onclick="executeQuick('NEWS'); toggleLab();" title="India News"><span class="material-symbols-rounded">newspaper</span></button>
                <button onclick="executeQuick('YOUTUBE:trending songs India'); toggleLab();" title="Trending Music"><span class="material-symbols-rounded">music_note</span></button>
                <button onclick="executeQuick('SHORTS'); toggleLab();" title="Trending Shorts"><span class="material-symbols-rounded">play_circle</span></button>
                <button onclick="executeQuick('SCREENSHOT'); toggleLab();" title="Screenshot"><span class="material-symbols-rounded">screenshot_region</span></button>
                <button onclick="executeQuick('EXPLORER'); toggleLab();" title="My Files"><span class="material-symbols-rounded">folder_open</span></button>
            </div>
            <div style="margin-top:20px; font-size:0.85rem; color:var(--accent); text-align:center; cursor:pointer; padding: 10px; border-radius: 10px; background: rgba(255,255,255,0.03);" onclick="fillSuggestion('Latest cricket score'); toggleLab();">
                üèè Live Cricket Score
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="settings-modal">
        <div class="settings-pane" style="max-height: 85vh; overflow-y: auto; scrollbar-width: thin;">
            <h2 style="color:white; display:flex; justify-content:space-between; margin-bottom:30px;">
                Settings <span class="material-symbols-rounded" style="cursor:pointer" onclick="toggleSettings()">close</span>
            </h2>

            <div class="settings-section" style="margin-bottom:25px;">
                <h4 style="color:var(--accent); margin-bottom:12px;">Appearance (Themes)</h4>
                <div class="theme-grid">
                    <div class="theme-btn" onclick="setTheme('dark')" id="theme-dark">Dark Night</div>
                    <div class="theme-btn" onclick="setTheme('light')" id="theme-light">Pure Light</div>
                    <div class="theme-btn" onclick="setTheme('cyber')" id="theme-cyber">Cyberpunk</div>
                    <div class="theme-btn" onclick="setTheme('matrix')" id="theme-matrix">Matrix AI</div>
                </div>
            </div>
            
            <div style="margin-bottom:20px; display:flex; justify-content:space-between; align-items:center; color:#ddd;">
                <span>God Mode (Coding)</span>
                <label class="switch"><input type="checkbox" id="mode-code"><span class="slider"></span></label>
            </div>

            <div style="margin-bottom:20px; color:#ddd;">
                <span>Response Depth</span>
                <select id="mode-len">
                    <option value="Normal">Balanced</option>
                    <option value="Detailed">Knowledge Architect</option>
                    <option value="Short">Efficient Core</option>
                </select>
            </div>

            <div style="margin-bottom:20px; color:#ddd;">
                <span>Your API Key (BYOK)</span>
                <div style="display:flex; gap:8px; margin-top:6px;">
                    <input id="user-api-key" type="password" placeholder="AIzaSy..." style="flex:1; padding:10px; border-radius:8px; border:1px solid var(--border); background:#111; color:white;" />
                    <button onclick="saveApiKey()" style="padding:10px; background:var(--primary); color:white; border:none; border-radius:8px; cursor:pointer;">Save</button>
                </div>
                <small style="color:#a1a1aa; font-size:0.8rem;">Use your own Gemini Key for privacy & speed.</small>

                <hr style="margin:12px 0; border-color: rgba(255,255,255,0.04);" />

                <label style="display:block; margin-bottom:6px;">Additional API Keys (Optional)</label>
                <input id="api-key-1" type="password" placeholder="Key 1 (e.g., Google)" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border); background:#111; color:white; margin-bottom:8px;" />
                <input id="api-key-2" type="password" placeholder="Key 2" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border); background:#111; color:white; margin-bottom:8px;" />
                <input id="api-key-3" type="password" placeholder="Key 3" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border); background:#111; color:white; margin-bottom:8px;" />
                <div style="display:flex; gap:8px; margin-top:6px;">
                    <button onclick="saveApiKeys()" style="padding:10px; background:#0f5132; color:white; border:none; border-radius:8px; cursor:pointer;">Save Keys</button>
                    <button onclick="clearApiKeysInputs()" style="padding:10px; background:#333; color:white; border:none; border-radius:8px; cursor:pointer;">Clear</button>
                </div>
                <small style="color:#a1a1aa; font-size:0.8rem;">These keys will be stored locally tied to your device for use in API requests; do not paste keys you do not trust.</small>
            </div>
            
            <div style="margin-top:auto; display: flex; flex-direction: column; gap: 10px; padding-bottom: 20px;">
                <button onclick="savePreferences()" style="padding:12px; background:#1f6f5f; color:white; border:1px solid #0f5132; border-radius:10px; cursor:pointer;">Save Model Preference</button>
                <button onclick="deleteAllChats()" style="padding:12px; background:#7f1d1d; color:white; border:1px solid #991b1b; border-radius:10px; cursor:pointer;">Delete ALL Chats</button>
                <div style="display: flex; gap: 10px;">
                    <button onclick="deleteChat()" style="flex-grow: 1; padding:12px; background:#c92a2a; color:white; border:none; border-radius:10px; cursor:pointer;">Delete Chat</button>
                    <button onclick="location.reload()" style="flex-grow: 1; padding:12px; background:#333; color:white; border:none; border-radius:10px; cursor:pointer;">Restart Vyom AI</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="register-modal" aria-hidden="true">
        <div class="settings-pane">
            <h2 style="color:white; display:flex; justify-content:space-between; margin-bottom:20px;">
                Welcome to Vyom AI <span class="material-symbols-rounded" style="cursor:pointer" onclick="hideRegisterModal()">close</span>
            </h2>
            <p style="color:#cfcfcf; margin-bottom:12px;">Let's set up your account so your chats are saved to your device.</p>
            <label style="color:#ddd; font-size:0.95rem">Name</label>
            <input id="reg-name" placeholder="Your name" style="width:100%; padding:10px; margin-top:6px; border-radius:8px; border:1px solid var(--border); background:#111; color:white;" />
            <label style="color:#ddd; font-size:0.95rem; margin-top:12px; display:block;">Email</label>
            <input id="reg-email" placeholder="you@example.com" style="width:100%; padding:10px; margin-top:6px; border-radius:8px; border:1px solid var(--border); background:#111; color:white;" />
            
            <label style="color:#ddd; font-size:0.95rem; margin-top:12px; display:block;">Gender</label>
            <select id="reg-gender">
                <option value="">Select Gender</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Non-binary">Non-binary</option>
                <option value="Other">Other</option>
                <option value="Prefer not to say">Prefer not to say</option>
            </select>
            
            <div style="margin-top:18px; display:flex; gap:10px;">
                <button onclick="submitRegister()" style="flex:1; padding:12px; background:var(--primary); color:white; border:none; border-radius:8px;">Create Account</button>
                <button onclick="hideRegisterModal()" style="padding:12px; background:#333; color:white; border:none; border-radius:8px;">Cancel</button>
            </div>
            <p style="color:#a1a1aa; font-size:0.9rem; margin-top:12px;">We only store your name and email locally for demo purposes.</p>
        </div>
    </div>
    <div class="copy-toast" id="copy-toast"></div>

    <script>
        const els = {
            body: document.body,
            box: document.getElementById('chat-box'),
            inp: document.getElementById('inp'),
            mic: document.getElementById('mic-btn'),
            modal: document.getElementById('settings-modal'),
            welcome: document.getElementById('welcome'),
            preview: document.getElementById('img-preview'),
            sendBtn: document.getElementById('send-btn'),
            userName: document.getElementById('user-name'),
            profileBtn: document.getElementById('profile-btn'),
            historyPanel: document.getElementById('history-panel')
        };
        let selectedFiles = []; 
        let lastUserContent = '';
        let DEVICE_ID = null;
        let CURRENT_USER = null;
        let CURRENT_CHAT_ID = null;
        let currentEngine = 'general';

        async function startNewChat() {
            try {
                const res = await fetch('/user/new_chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ device_id: DEVICE_ID })
                });
                const chat = await res.json();
                if (chat.id) {
                    await loadChatSessions();
                    loadChat(chat.id);
                } else {
                    if (chat.error === "User not found") {
                        await registerGuest();
                        const retryRes = await fetch('/user/new_chat', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ device_id: DEVICE_ID })
                        });
                        const retryChat = await retryRes.json();
                        if (retryChat.id) {
                            await loadChatSessions();
                            loadChat(retryChat.id);
                        }
                    }
                }
            } catch (e) { console.error(e); }
        }

        async function registerGuest() {
            try {
                await fetch('/user/register', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        device_id: DEVICE_ID, 
                        name: 'Guest', 
                        email: 'guest@vyom.ai' 
                    })
                });
            } catch(e) { console.error("Guest Reg Failed", e); }
        }

        async function loadChatSessions() {
            if (!DEVICE_ID) return;
            try {
                const res = await fetch(`/user/chats?device_id=${encodeURIComponent(DEVICE_ID)}`);
                const chats = await res.json();
                
                const list = document.getElementById('history-list');
                list.innerHTML = '';
                
                if (chats.length > 0 && !CURRENT_CHAT_ID) {
                    loadChat(chats[0].id);
                } else if (chats.length === 0 && !CURRENT_CHAT_ID) {
                    startNewChat();
                    return;
                }
                
                chats.forEach(chat => {
                    const div = document.createElement('div');
                    div.className = `history-item ${chat.id === CURRENT_CHAT_ID ? 'active' : ''}`;
                    div.innerHTML = `
                        <span class="history-item-title" onclick="loadChat('${chat.id}')">${chat.title}</span>
                        <div class="history-item-actions">
                            <button onclick="deleteChat('${chat.id}', event)"><span class="material-symbols-rounded" style="font-size:16px">delete</span></button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            } catch (e) { console.error(e); }
        }
        
        async function loadChat(chatId) {
            CURRENT_CHAT_ID = chatId;
            loadChatSessions(); 
            els.box.innerHTML = '';
            els.welcome = null;

            try {
                const res = await fetch(`/user/history?device_id=${encodeURIComponent(DEVICE_ID)}&chat_id=${chatId}`);
                const data = await res.json();
                const history = data.history || [];
                
                if (history.length > 0) {
                    history.forEach(line => {
                        let role = 'ai';
                        let content = line;
                        if (line.startsWith('User: ')) {
                            role = 'user';
                            content = line.replace('User: ', '');
                        } else if (line.startsWith('Vyom AI: ')) {
                            content = line.replace('Vyom AI: ', '');
                        }
                        
                        addMsg(content, role, true);
                        
                        const lastMsg = els.box.lastElementChild;
                        if(lastMsg) {
                            const bubble = lastMsg.querySelector('.msg-bubble');
                            if(bubble) {
                                bubble.innerHTML = marked.parse(content);
                                bubble.querySelectorAll('pre code').forEach(b => hljs.highlightElement(b));
                                addCodeCopyButtons(bubble);
                            }
                        }
                    });
                }
                els.box.scrollTop = els.box.scrollHeight;
            } catch (e) { console.error("Failed to load chat", e); }
        }

        async function deleteChat(chatId = CURRENT_CHAT_ID, event) {
            if(event) event.stopPropagation();
            if(!confirm('Delete this chat?')) return;
            
            try {
                await fetch(`/user/delete_chat`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ device_id: DEVICE_ID, chat_id: chatId })
                });
                
                if (chatId === CURRENT_CHAT_ID) {
                    CURRENT_CHAT_ID = null;
                    els.box.innerHTML = '';
                    startNewChat();
                } else {
                    loadChatSessions();
                }
            } catch(e) { console.error(e); }
        }

        async function deleteAllChats() {
            if(!confirm('Are you sure you want to delete ALL chat history? This cannot be undone.')) return;
            
            try {
                const res = await fetch('/chats', {
                    method: 'DELETE',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ device_id: DEVICE_ID })
                });
                
                if (res.ok) {
                    CURRENT_CHAT_ID = null;
                    startNewChat();
                    alert('All chats deleted.');
                } else {
                    alert('Failed to delete chats.');
                }
            } catch(e) { console.error(e); alert('Error connecting to server.'); }
        }

        async function captureCamera() {
            const btn = document.querySelector('button[onclick="captureCamera()"]');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<span class="material-symbols-rounded orbit-spinner" style="font-size:20px">sync</span>';
            btn.disabled = true;

            try {
                const res = await fetch('/camera/capture', { method: 'POST' });
                const data = await res.json();
                
                if (data.image_url) {
                    const imgRes = await fetch(data.image_url);
                    const blob = await imgRes.blob();
                    const file = new File([blob], "camera_capture.jpg", { type: "image/jpeg" });
                    
                    selectedFiles.push(file);
                    renderPreviews();
                    updateSendState();
                } else {
                    alert('Camera capture failed: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error(e);
                alert('Camera request failed.');
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }

        function toggleHistory() {
            els.body.classList.toggle('history-collapsed');
        }

        function toggleLab() {
            const modal = document.getElementById('lab-modal');
            modal.classList.toggle('active');
        }

        function getDeviceId() {
            let id = localStorage.getItem('vyom_device_id');
            if (!id) {
                if (window.crypto && crypto.randomUUID) id = crypto.randomUUID();
                else id = 'dev-' + Math.random().toString(36).slice(2, 10);
                localStorage.setItem('vyom_device_id', id);
            }
            return id;
        }

        let CURRENT_THEME = localStorage.getItem('vyom_theme') || 'dark';

        function setTheme(theme) {
            document.body.classList.remove('theme-dark', 'theme-light', 'theme-cyber', 'theme-matrix');
            document.body.classList.add('theme-' + theme);
            CURRENT_THEME = theme;
            localStorage.setItem('vyom_theme', theme);
            
            document.querySelectorAll('.theme-btn').forEach(b => {
                b.classList.toggle('active', b.id === 'theme-' + theme);
            });
        }

        // Auto-detect mobile and adjust UI
        function initResponsive() {
            const isMobile = window.innerWidth <= 768;
            if (isMobile) {
                document.body.classList.add('history-collapsed');
            }
            setTheme(CURRENT_THEME);
        }

        window.addEventListener('resize', () => {
            if (window.innerWidth <= 768) {
                document.body.classList.add('history-collapsed');
            }
        });

        async function checkUser() {
            DEVICE_ID = getDeviceId();
            try {
                const res = await fetch(`/user/check?device_id=${encodeURIComponent(DEVICE_ID)}`);
                const data = await res.json();
                if (data.registered) {
                    CURRENT_USER = data.user;
                    const isGuest = data.is_guest || (CURRENT_USER.name === 'Guest');
                    const userName = isGuest ? 'Explorer' : (CURRENT_USER.name || 'User');
                    
                    els.userName.textContent = userName;
                    els.profileBtn.textContent = userName.charAt(0).toUpperCase();
                    
                    if (isGuest) {
                        document.getElementById('welcome-sub').textContent = "Welcome! Sign in to unlock full AI potential.";
                    } else {
                        document.getElementById('welcome-sub').textContent = `Welcome back, ${userName}!`;
                    }
                    
                    if (CURRENT_USER.api_key) {
                        document.getElementById('user-api-key').placeholder = 'Saved ‚úÖ';
                    }
                    await loadChatSessions();
                } else {
                    // Fail-safe guest mode
                    els.userName.textContent = 'Explorer';
                }
            } catch (e) {
                console.warn('User check failed', e);
            }
        }

        function toggleSettings() { els.modal.classList.toggle('active'); }
        
        async function fetchModels() {
            try {
                const res = await fetch('/models');
                const data = await res.json();
                const selector = document.getElementById('mode-selector');
                selector.innerHTML = '';
                
                const order = ['general', 'coding', 'math', 'reasoning', 'trinity', 'image'];
                const engines = Object.keys(data).sort((a, b) => {
                    let ia = order.indexOf(a);
                    let ib = order.indexOf(b);
                    if (ia === -1) ia = 99;
                    if (ib === -1) ib = 99;
                    return ia - ib;
                });

                engines.forEach(key => {
                    const info = data[key];
                    const chip = document.createElement('span');
                    chip.className = 'mode-chip';
                    if (key === currentEngine) chip.classList.add('active');
                    chip.textContent = info.display || key;
                    chip.dataset.engine = key;
                    chip.onclick = () => selectMode(key);
                    selector.appendChild(chip);
                });
                
                if (CURRENT_USER && CURRENT_USER.default_engine) {
                    selectMode(CURRENT_USER.default_engine);
                }
            } catch (e) { console.error('Failed to load models', e); }
        }

        function selectMode(engine) {
            currentEngine = engine;
            document.querySelectorAll('.mode-chip').forEach(c => {
                c.classList.toggle('active', c.dataset.engine === engine);
            });
            // Auto close menu after selection for better UX
            toggleToolsMenu(false);
        }

        function toggleToolsMenu(force) {
            const menu = document.getElementById('mode-selector');
            const btn = document.getElementById('tools-btn');
            const isNowActive = force !== undefined ? force : !menu.classList.contains('active');
            
            menu.classList.toggle('active', isNowActive);
            btn.classList.toggle('active', isNowActive);
        }

        function updateEngineUI() {
            fetchModels();
        }

        function fillSuggestion(text) { els.inp.value = text; els.inp.dispatchEvent(new Event('input')); sendMessage(); }

        async function savePreferences() {
            if (!DEVICE_ID) return alert('No device ID available.');
            const engine = currentEngine;
            const model = null; // Default to best model for selected engine
            try {
                const res = await fetch('/user/save_pref', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ device_id: DEVICE_ID, engine, model })
                });
                const data = await res.json();
                if (data.success) showCopyToast('Preferences saved');
                else alert('Failed to save preferences');
            } catch (e) { console.error(e); alert('Save failed'); }
        }

        function showPreview(input) {
            if (input.files && input.files.length > 0) {
                selectedFiles = Array.from(input.files);
                renderPreviews();
            }
            updateSendState();
        }

        function renderPreviews() {
            els.preview.innerHTML = '<span class="material-symbols-rounded preview-close" onclick="clearFile()">close</span>';
            els.preview.style.display = 'flex';
            
            selectedFiles.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.className = 'preview-img';
                    img.style.marginRight = '5px';
                    const reader = new FileReader();
                    reader.onload = (e) => { img.src = e.target.result; };
                    reader.readAsDataURL(file);
                    els.preview.insertBefore(img, els.preview.firstChild);
                } else {
                    const span = document.createElement('span');
                    span.textContent = 'üìÑ';
                    span.style.fontSize = '24px';
                    span.style.marginRight = '5px';
                    els.preview.insertBefore(span, els.preview.firstChild);
                }
            });
        }

        function clearFile() {
            selectedFiles = [];
            document.getElementById('file-up').value = "";
            els.preview.style.display = 'none';
            els.preview.innerHTML = '';
            updateSendState();
        }

        function updateSendState() {
            const hasContent = els.inp.value.trim().length > 0 || selectedFiles.length > 0;
            els.sendBtn.disabled = !hasContent;
        }

        function formatTime(ts = Date.now()) {
            const d = new Date(ts);
            return d.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
        }

        async function executeQuick(cmd) {
            try {
                const res = await fetch('/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: `[[${cmd}]]`,
                        device_id: DEVICE_ID,
                        chat_id: CURRENT_CHAT_ID,
                        input_mode: 'text', // Command is effectively text
                        settings: { engine: 'general' }
                    })
                });
                const data = await res.json();
                // We don't necessarily show the answer if it's just a command
                if (data.answer && !data.answer.includes('[[') && !data.answer.includes('Opening')) {
                    addMsg(data.answer, 'ai', true);
                }
            } catch (e) { console.error(e); }
        }

        async function playVoice(id) {
            const el = document.querySelector('#' + id + ' .msg-bubble');
            if(!el) return;
            // Get clean text (remove code blocks for speech if desired, or send all)
            const text = el.innerText || el.textContent;
            
            // Gender from profile
            const gender = CURRENT_USER ? CURRENT_USER.gender : null;

            try {
                await fetch('/voice/speak_manual', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ text, gender })
                });
            } catch(e) { console.error(e); }
        }

        async function sendMessage(inputMode = 'text') {
            let txt = els.inp.value.trim();
            if(!txt && selectedFiles.length === 0) return;

            if (!CURRENT_CHAT_ID) {
                await startNewChat();
                if (!CURRENT_CHAT_ID) return alert("Failed to start a chat session. Please refresh.");
            }

            if(els.welcome) {
                els.welcome.style.display = 'none';
                if (els.welcome.parentNode) els.welcome.parentNode.removeChild(els.welcome);
                els.welcome = null;
            }
            
            lastUserContent = txt;
            let userContent = txt;
            
            if(selectedFiles.length > 0) {
                userContent += '<br><div style="display:flex; gap:5px; flex-wrap:wrap; margin-top:5px;">';
                for (let file of selectedFiles) {
                    if(file.type.startsWith('image/')) {
                         userContent += `<span>üñºÔ∏è ${file.name}</span>`;
                    } else {
                        userContent += `<span>üìÑ ${file.name}</span>`;
                    }
                }
                userContent += '</div>';
            }
            
            addMsg(userContent, 'user', true);
            els.inp.value = ''; els.inp.style.height = 'auto'; updateSendState();

            let attachments = [];
            if (selectedFiles.length > 0) {
                let formData = new FormData();
                selectedFiles.forEach(file => {
                    formData.append('files[]', file);
                });
                formData.append('device_id', DEVICE_ID);
                formData.append('chat_id', CURRENT_CHAT_ID);
                
                try {
                    const upRes = await fetch('/upload', { method: 'POST', body: formData });
                    const upData = await upRes.json();
                    if (upData.success) {
                        attachments = upData.files;
                    }
                } catch(e) {
                    console.error("Upload failed", e);
                    addMsg("‚ö†Ô∏è Upload failed.", 'ai', true, {error:true});
                    return;
                }
            }
            clearFile();

            const loadId = showLoader();
            els.sendBtn.disabled = true;

            try {
                const settings = {
                    codingMode: document.getElementById('mode-code').checked,
                    wordControl: document.getElementById('mode-len').value,
                    engine: currentEngine,
                    model: null
                };

                const res = await fetch('/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: txt,
                        device_id: DEVICE_ID,
                        chat_id: CURRENT_CHAT_ID,
                        input_mode: inputMode,
                        settings: settings,
                        attachments: attachments
                    })
                });

                document.getElementById(loadId).remove();
                
                const data = await res.json();
                const aiMsgContent = data.answer || "‚ö†Ô∏è No response received.";
                
                const aiMsgId = addMsg('', 'ai', false);
                const aiMsgBubble = document.querySelector(`#${aiMsgId} .msg-bubble`);

                aiMsgBubble.innerHTML = marked.parse(aiMsgContent);
                els.box.scrollTop = els.box.scrollHeight;

                aiMsgBubble.querySelectorAll('pre code').forEach(b => hljs.highlightElement(b));
                addCodeCopyButtons(aiMsgBubble);

                await loadChatSessions(); 
            } catch (e) {
                if(document.getElementById(loadId)) document.getElementById(loadId).remove();
                addMsg(`<b>‚ö†Ô∏è Vyom AI is Offline.</b>`, 'ai', true, { error: true });
                console.error('Ask failed', e);
            } finally {
                updateSendState();
            }
        }

        async function saveApiKey() {
            const key = document.getElementById('user-api-key').value.trim();
            if (!key) return alert("Please enter a valid API Key.");
            
            try {
                const res = await fetch('/user/save_key', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ device_id: DEVICE_ID, api_key: key })
                });
                const data = await res.json();
                
                if (data.success) {
                    showCopyToast("API Key Saved Successfully!");
                    document.getElementById('user-api-key').value = "";
                    document.getElementById('user-api-key').placeholder = "Saved ‚úÖ (Enter new to overwrite)";
                } else {
                    alert("Failed to save key.");
                }
            } catch (e) {
                console.error(e);
                alert("Error connecting to server.");
            }
        }

        async function saveApiKeys() {
            if (!DEVICE_ID) return alert('No device ID available.');
            const k1 = document.getElementById('api-key-1').value.trim();
            const k2 = document.getElementById('api-key-2').value.trim();
            const k3 = document.getElementById('api-key-3').value.trim();
            const keys = {};
            if (k1) keys['key1'] = k1;
            if (k2) keys['key2'] = k2;
            if (k3) keys['key3'] = k3;
            if (Object.keys(keys).length === 0) return alert('Enter at least one key');

            try {
                const res = await fetch('/user/save_keys', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ device_id: DEVICE_ID, keys })
                });
                const data = await res.json();
                if (data.success) {
                    showCopyToast('API Keys Saved');
                    // Clear inputs for safety
                    document.getElementById('api-key-1').value = '';
                    document.getElementById('api-key-2').value = '';
                    document.getElementById('api-key-3').value = '';
                } else {
                    alert('Failed to save API keys');
                }
            } catch (e) { console.error(e); alert('Save failed'); }
        }

        function clearApiKeysInputs() {
            document.getElementById('api-key-1').value = '';
            document.getElementById('api-key-2').value = '';
            document.getElementById('api-key-3').value = '';
        }

        async function submitRegister() {
            const name = document.getElementById('reg-name').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const gender = document.getElementById('reg-gender').value;
            
            if (!name || !email) return alert('Please enter name and email');
            if (!gender) return alert('Please select your gender');
            if (!/^\S+@\S+\.\S+$/.test(email)) return alert('Enter a valid email address');
            
            const payload = { device_id: DEVICE_ID, name, email, gender };
            try {
                const res = await fetch('/user/register', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
                const data = await res.json();
                if (data.registered) {
                    CURRENT_USER = data.user;
                    const userName = CURRENT_USER.name;
                    els.userName.textContent = userName;
                    els.profileBtn.textContent = userName.charAt(0).toUpperCase();
                    document.getElementById('welcome-sub').textContent = `Welcome, ${userName}!`;
                    hideRegisterModal();
                    await loadChatSessions();
                } else if (data.error) {
                    alert('Registration failed: ' + data.error);
                } else {
                    alert('Registration failed');
                }
            } catch (e) { console.error('Register failed', e); alert('Registration failed'); }
        }

        function showRegisterModal() { document.getElementById('register-modal').classList.add('active'); }
        function hideRegisterModal() { document.getElementById('register-modal').classList.remove('active'); }

        function showLoader() {
            const id = 'load-' + Date.now();
            const div = document.createElement('div'); div.id = id; div.className = 'msg-row ai';
            div.innerHTML = `
                <div class="msg-avatar"><img src="logo.png" onerror="this.style.display='none'"></div>
                <div class="thinking-wrapper">
                    <div class="orbit-spinner">
                        <img src="logo.png" class="orbit-logo" onerror="this.style.display='none'">
                        <div class="ring"></div>
                        <div class="ring"></div>
                    </div>
                    <span class="thinking-text">Processing...</span>
                </div>
            `;
            els.box.appendChild(div); els.box.scrollTop = els.box.scrollHeight;
            return id;
        }

        function addMsg(content, role, raw=false, opts={}) {
            const id = opts.id || (role + '-' + Date.now());
            const ts = opts.timestamp || Date.now();
            
            const msgRow = document.createElement('div');
            msgRow.className = `msg-row ${role}`;
            msgRow.id = id;
            
            const avatarHTML = `<div class="msg-avatar"><img src="logo.png" onerror="this.style.display='none'"></div>`;
            const bubbleHTML = `<div class="msg-bubble">${raw ? content : ''}</div>`;
            const metaHTML = `
                <div class="msg-meta">
                    <span class="time">${formatTime(ts)}</span>
                    <div class="msg-actions">
                        ${role === 'ai' ? `<button onclick="playVoice('${id}')" title="Read Aloud"><span class="material-symbols-rounded" style="font-size:16px">volume_up</span></button>` : ''}
                        <button onclick="copyMsg('${id}')">Copy</button>
                        ${role === 'ai' && !opts.error ? `<button onclick="retryLast()">Retry</button>` : ''}
                    </div>
                </div>`;
            
            if (role === 'ai') {
                msgRow.innerHTML = avatarHTML + '<div class="msg-content">' + bubbleHTML + metaHTML + '</div>';
            } else if (role === 'user') {
                msgRow.innerHTML = '<div class="msg-content">' + bubbleHTML + metaHTML + '</div>';
            }

            if(!raw && content) {
                const bubble = msgRow.querySelector('.msg-bubble');
                bubble.textContent = content;
            }

            els.box.appendChild(msgRow);
            els.box.scrollTop = els.box.scrollHeight;
            return id;
        }
        
        function addCodeCopyButtons(bubble) {
            bubble.querySelectorAll('pre').forEach(pre => {
                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-code-btn';
                copyBtn.textContent = 'Copy Code';
                copyBtn.onclick = () => {
                    const code = pre.querySelector('code').innerText;
                    navigator.clipboard.writeText(code).then(() => {
                        copyBtn.textContent = 'Copied!';
                        setTimeout(() => copyBtn.textContent = 'Copy Code', 2000);
                    });
                };
                pre.appendChild(copyBtn);
            });
        }

        function copyMsg(id) {
            const el = document.querySelector('#' + id + ' .msg-bubble');
            if(!el) return;
            const text = el.innerText || el.textContent;
            navigator.clipboard.writeText(text).then(()=>{
                showCopyToast('Copied to clipboard');
            }).catch(()=> showCopyToast('Copy failed'));
        }

        function showCopyToast(msg) {
            let t = document.getElementById('copy-toast');
            t.textContent = msg;
            t.classList.add('show');
            clearTimeout(t._hideTimer);
            t._hideTimer = setTimeout(()=> t.classList.remove('show'), 1600);
        }

        function retryLast() {
            if (!lastUserContent) return;

            const messages = els.box.querySelectorAll('.msg-row');
            if (messages.length >= 2) {
                messages[messages.length - 1].remove();
                messages[messages.length - 2].remove();
            } else if (messages.length === 1) {
                messages[0].remove();
            }

            els.inp.value = lastUserContent;
            sendMessage();
        }
        
        els.inp.addEventListener('input', function() { this.style.height='auto'; this.style.height=(this.scrollHeight)+'px'; updateSendState(); });
        els.inp.addEventListener('keydown', (e) => { if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });

        let rec = null;
        if('webkitSpeechRecognition' in window) {
            rec = new webkitSpeechRecognition(); rec.lang = 'en-IN';
            rec.continuous = false;
            rec.interimResults = false;
            rec.onstart = () => els.mic.classList.add('mic-active');
            rec.onend = () => els.mic.classList.remove('mic-active');
            rec.onresult = (e) => { 
                els.inp.value = e.results[0][0].transcript; 
                // Auto-send on voice input
                sendMessage('voice'); 
            };
            rec.onerror = (e) => { console.error("Speech recognition error", e); els.mic.classList.remove('mic-active'); };
        }
        els.mic.onclick = () => { 
            if (!rec) return alert("Your browser doesn't support voice input.");
            if (els.mic.classList.contains('mic-active')) {
                rec.stop();
            } else {
                try { rec.start() } catch(e) { console.error(e); } 
            }
        };

        updateSendState();
        checkUser();
        fetchModels();
        if(window.innerWidth < 768) {
             els.body.classList.add('history-collapsed');
        } else {
             els.body.classList.remove('history-collapsed');
        }

        // --- AUTOMATION: Location, News & Music ---
        async function initLocationServices() {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(async (position) => {
                    const { latitude, longitude } = position.coords;
                    try {
                        const res = await fetch('/user/location', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ device_id: DEVICE_ID, lat: latitude, lon: longitude })
                        });
                        const data = await res.json();
                        if (data.success && data.city) {
                            showCopyToast(`üìç Location detected: ${data.city}`);
                            // Auto trigger news and music if it's a new chat or first time in session
                            if (!sessionStorage.getItem('vyom_auto_triggered')) {
                                setTimeout(() => {
                                    addMsg(`üìç **Auto-Intelligence:** I've detected you're in **${data.city}**. Fetching local news and trending music for you...`, 'ai', true);
                                    executeQuick(`NEWS:${data.city}`);
                                    executeQuick(`YOUTUBE:trending songs in ${data.city}`);
                                    sessionStorage.setItem('vyom_auto_triggered', 'true');
                                }, 2000);
                            }
                        }
                    } catch (e) { console.error("Location sync failed", e); }
                }, (error) => {
                    console.warn("Geolocation denied or failed", error);
                });
            }
        }
        
        // Run after a short delay to ensure DEVICE_ID is ready
        setTimeout(initLocationServices, 3000);
    </script>
</body>
</html>